# Test miscellaneous commands: feedback, auth, hb

# Test feedback command validation - no arguments
! exec ./nlm_test feedback
stderr 'usage: nlm feedback <message>'
! stderr 'panic'

# Test feedback command - requires authentication without auth tokens
! exec ./nlm_test feedback 'test message'
stderr 'Authentication required for.*feedback.*Run.*nlm auth.*first'
! stderr 'panic'

# Test feedback command with authentication - basic message (API returns error)
env NLM_AUTH_TOKEN=test-token
env NLM_COOKIES=test-cookies
! exec ./nlm_test feedback 'Basic test feedback message'
stderr 'SubmitFeedback: RPC ID not defined in proto'
! stderr 'Authentication required'
! stderr 'panic'

# Test feedback command - empty message (API error expected)
env NLM_AUTH_TOKEN=test-token
env NLM_COOKIES=test-cookies
! exec ./nlm_test feedback ''
stderr 'SubmitFeedback: RPC ID not defined in proto'
! stderr 'Authentication required'
! stderr 'usage:'
! stderr 'panic'

# Test feedback command - message with spaces (API error expected)
env NLM_AUTH_TOKEN=test-token
env NLM_COOKIES=test-cookies
! exec ./nlm_test feedback 'This is a longer feedback message with multiple words'
stderr 'SubmitFeedback: RPC ID not defined in proto'
! stderr 'Authentication required'
! stderr 'usage:'
! stderr 'panic'

# Test feedback command - message with special characters (API error expected)
env NLM_AUTH_TOKEN=test-token
env NLM_COOKIES=test-cookies
! exec ./nlm_test feedback 'Feedback with special chars: @#$%^&*()[]{}|;:,.<>?'
stderr 'SubmitFeedback: RPC ID not defined in proto'
! stderr 'Authentication required'
! stderr 'usage:'
! stderr 'panic'

# Test feedback command - message with quotes (API error expected)
env NLM_AUTH_TOKEN=test-token
env NLM_COOKIES=test-cookies
! exec ./nlm_test feedback 'Message with "quotes" and '\''apostrophes'\'''
stderr 'SubmitFeedback: RPC ID not defined in proto'
! stderr 'Authentication required'
! stderr 'usage:'
! stderr 'panic'

# Test feedback command - very long message (API error expected)
env NLM_AUTH_TOKEN=test-token
env NLM_COOKIES=test-cookies
! exec ./nlm_test feedback 'This is a very long feedback message that contains many words and should test how the system handles longer input strings without breaking or causing any issues with argument parsing or processing'
stderr 'SubmitFeedback: RPC ID not defined in proto'
! stderr 'Authentication required'
! stderr 'usage:'
! stderr 'panic'

# Test feedback command - too many arguments
env NLM_AUTH_TOKEN=test-token
env NLM_COOKIES=test-cookies
! exec ./nlm_test feedback 'first message' 'second message'
stderr 'usage: nlm feedback <message>'
! stderr 'panic'

# Test feedback command with debug flag (API error expected)
env NLM_AUTH_TOKEN=test-token
env NLM_COOKIES=test-cookies
! exec ./nlm_test -debug feedback 'Debug test message'
stderr 'SubmitFeedback: RPC ID not defined in proto'
! stderr 'Authentication required'
! stderr 'usage:'
! stderr 'panic'

# Test feedback command with chunked flag (API error expected)
env NLM_AUTH_TOKEN=test-token
env NLM_COOKIES=test-cookies
! exec ./nlm_test -chunked feedback 'Chunked response test message'
stderr 'SubmitFeedback: RPC ID not defined in proto'
! stderr 'Authentication required'
! stderr 'usage:'
! stderr 'panic'

# Test feedback command with both debug and chunked flags (API error expected)
env NLM_AUTH_TOKEN=test-token
env NLM_COOKIES=test-cookies
! exec ./nlm_test -debug -chunked feedback 'Debug and chunked test message'
stderr 'SubmitFeedback: RPC ID not defined in proto'
! stderr 'Authentication required'
! stderr 'usage:'
! stderr 'panic'

# Test feedback command with partial auth (token only)
env NLM_AUTH_TOKEN=test-token
env NLM_COOKIES=
! exec ./nlm_test feedback 'test message'
stderr 'Authentication required'
! stderr 'panic'

# Test feedback command with partial auth (cookies only)
env NLM_AUTH_TOKEN=
env NLM_COOKIES=test-cookies
! exec ./nlm_test feedback 'test message'
stderr 'Authentication required'
! stderr 'panic'

# Test auth command - no arguments (fails due to no browser profiles in test env)
! exec ./nlm_test auth
stderr 'browser auth failed.*no valid profiles found'
! stderr 'Authentication required'
! stderr 'usage:'
! stderr 'panic'

# Test auth command - with profile argument (fails in test env)
! exec ./nlm_test auth 'test-profile'
stderr 'browser auth failed.*no valid profiles found'
! stderr 'Authentication required'
! stderr 'usage:'
! stderr 'panic'

# Test auth command - with multiple profile arguments (fails in test env)
! exec ./nlm_test auth 'profile1' 'profile2'
stderr 'browser auth failed.*no valid profiles found'
! stderr 'Authentication required'
! stderr 'usage:'
! stderr 'panic'

# Test auth command with debug flag (fails in test env)
! exec ./nlm_test -debug auth
stderr 'browser auth failed.*no valid profiles found'
! stderr 'Authentication required'
! stderr 'usage:'
! stderr 'panic'

# Test auth command with chunked flag (fails in test env)
! exec ./nlm_test -chunked auth
stderr 'browser auth failed.*no valid profiles found'
! stderr 'Authentication required'
! stderr 'usage:'
! stderr 'panic'

# Test auth command with help flag
exec ./nlm_test auth --help
! stderr 'Authentication required'
! stderr 'panic'

# Test auth command with -h flag
exec ./nlm_test auth -h
! stderr 'Authentication required'
! stderr 'panic'

# Test auth command with help argument (shows help text like flags do)
exec ./nlm_test auth help
stderr 'Usage: nlm auth'
! stderr 'Authentication required'
! stderr 'panic'

# Test auth command - special character profile names (fails in test env)
! exec ./nlm_test auth 'profile-with-dashes'
stderr 'browser auth failed.*no valid profiles found'
! stderr 'Authentication required'
! stderr 'usage:'
! stderr 'panic'

! exec ./nlm_test auth 'profile_with_underscores'
stderr 'browser auth failed.*no valid profiles found'
! stderr 'Authentication required'
! stderr 'usage:'
! stderr 'panic'

! exec ./nlm_test auth 'profile.with.dots'
stderr 'browser auth failed.*no valid profiles found'
! stderr 'Authentication required'
! stderr 'usage:'
! stderr 'panic'

# Test auth command - empty profile name (fails in test env)
! exec ./nlm_test auth ''
stderr 'browser auth failed.*no valid profiles found'
! stderr 'Authentication required'
! stderr 'usage:'
! stderr 'panic'

# Test auth command with existing auth tokens (still fails due to no browser profiles)
env NLM_AUTH_TOKEN=existing-token
env NLM_COOKIES=existing-cookies
! exec ./nlm_test auth
stderr 'browser auth failed.*no valid profiles found'
! stderr 'Authentication required'
! stderr 'usage:'
! stderr 'panic'

# Test hb (heartbeat) command - no arguments, requires auth
env NLM_AUTH_TOKEN=
env NLM_COOKIES=
! exec ./nlm_test hb
stderr 'Authentication required for.*hb.*Run.*nlm auth.*first'
! stderr 'panic'

# Test hb command with authentication
env NLM_AUTH_TOKEN=test-token
env NLM_COOKIES=test-cookies
exec ./nlm_test hb
! stderr 'Authentication required'
! stderr 'usage:'
! stderr 'panic'

# Test hb command - too many arguments (should ignore extra args)
env NLM_AUTH_TOKEN=test-token
env NLM_COOKIES=test-cookies
exec ./nlm_test hb extra-arg
! stderr 'Authentication required'
! stderr 'usage:'
! stderr 'panic'

# Test hb command with debug flag
env NLM_AUTH_TOKEN=test-token
env NLM_COOKIES=test-cookies
exec ./nlm_test -debug hb
! stderr 'Authentication required'
! stderr 'usage:'
! stderr 'panic'

# Test hb command with chunked flag
env NLM_AUTH_TOKEN=test-token
env NLM_COOKIES=test-cookies
exec ./nlm_test -chunked hb
! stderr 'Authentication required'
! stderr 'usage:'
! stderr 'panic'

# Test hb command with both flags
env NLM_AUTH_TOKEN=test-token
env NLM_COOKIES=test-cookies
exec ./nlm_test -debug -chunked hb
! stderr 'Authentication required'
! stderr 'usage:'
! stderr 'panic'

# Test hb command with partial auth (token only)
env NLM_AUTH_TOKEN=test-token
env NLM_COOKIES=
! exec ./nlm_test hb
stderr 'Authentication required'
! stderr 'panic'

# Test hb command with partial auth (cookies only)
env NLM_AUTH_TOKEN=
env NLM_COOKIES=test-cookies
! exec ./nlm_test hb
stderr 'Authentication required'
! stderr 'panic'

# Test that all commands handle unicode properly (API error expected)
env NLM_AUTH_TOKEN=test-token
env NLM_COOKIES=test-cookies
! exec ./nlm_test feedback 'ÊµãËØïÊ∂àÊÅØ with Êó•Êú¨Ë™û and √©mojis üöÄ'
stderr 'SubmitFeedback: RPC ID not defined in proto'
! stderr 'Authentication required'
! stderr 'usage:'
! stderr 'panic'

# Test commands with very long arguments (API error expected)
env NLM_AUTH_TOKEN=test-token
env NLM_COOKIES=test-cookies
! exec ./nlm_test feedback 'Lorem ipsum dolor sit amet consectetur adipiscing elit sed do eiusmod tempor incididunt ut labore et dolore magna aliqua Ut enim ad minim veniam quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur Excepteur sint occaecat cupidatat non proident sunt in culpa qui officia deserunt mollit anim id est laborum'
stderr 'SubmitFeedback: RPC ID not defined in proto'
! stderr 'Authentication required'
! stderr 'usage:'
! stderr 'panic'

# Test auth command with extremely long profile name (fails in test env)
! exec ./nlm_test auth 'this-is-an-extremely-long-profile-name-that-might-test-limits-of-argument-processing-and-should-not-cause-any-crashes-or-panics-in-the-system'
stderr 'browser auth failed.*no valid profiles found'
! stderr 'Authentication required'
! stderr 'usage:'

# Test that environment variables are properly isolated between tests
env NLM_AUTH_TOKEN=
env NLM_COOKIES=
! exec ./nlm_test feedback 'Should require auth again'
stderr 'Authentication required'
! stderr 'panic'

# Test commands don't crash on malformed environment (API error expected)
env NLM_AUTH_TOKEN='malformed token with\nnewlines'
env NLM_COOKIES='malformed=cookies;with\ttabs'
! exec ./nlm_test feedback 'Test with malformed env vars'
stderr 'SubmitFeedback: RPC ID not defined in proto'
! stderr 'panic'

# Test feedback with newlines in message (API error expected)  
env NLM_AUTH_TOKEN=test-token
env NLM_COOKIES=test-cookies
! exec ./nlm_test feedback 'Line 1\nLine 2\nLine 3'
stderr 'SubmitFeedback: RPC ID not defined in proto'
! stderr 'Authentication required'
! stderr 'usage:'
! stderr 'panic'

# Test edge case - feedback with only whitespace (API error expected)
env NLM_AUTH_TOKEN=test-token
env NLM_COOKIES=test-cookies
! exec ./nlm_test feedback '   '
stderr 'SubmitFeedback: RPC ID not defined in proto'
! stderr 'Authentication required'
! stderr 'usage:'
! stderr 'panic'

# Test edge case - auth with only whitespace profile (fails in test env)
! exec ./nlm_test auth '   '
stderr 'browser auth failed.*no valid profiles found'
! stderr 'Authentication required'
! stderr 'usage:'
! stderr 'panic'