# Test authentication parsing issue reproduction
# This test reproduces the specific issue where 'nlm ls' without auth
# shows confusing parsing errors instead of clean auth error

# Test list command without auth - should show clean auth error and exit
! exec ./nlm_test ls
stderr 'Authentication required for.*ls.*Run.*nlm auth.*first'
stderr 'nlm: authentication required'
# Should NOT show parsing errors or debug output to stderr
! stderr 'parse response'
! stderr 'beprotojson'
! stderr 'chunked parser'
! stderr 'DEBUG: Raw response'
! stderr 'Attempting to manually extract'

# Test with invalid auth tokens - should make API call and fail with parsing errors
# (this is expected behavior when auth tokens are provided but invalid)
env NLM_AUTH_TOKEN=invalid-token
env NLM_COOKIES=invalid-cookies
! exec ./nlm_test ls
# Should not show the auth required message since tokens are provided
! stderr 'Authentication required for.*ls.*Run.*nlm auth.*first'
! stderr 'nlm: authentication required'
# Should show API errors because invalid tokens cause API failure
stderr 'API error|Authentication|execute rpc'

# Test short alias without auth
env NLM_AUTH_TOKEN=
env NLM_COOKIES=
! exec ./nlm_test list
stderr 'Authentication required for.*list.*Run.*nlm auth.*first'
stderr 'nlm: authentication required'
! stderr 'parse response'
! stderr 'beprotojson'