# Comprehensive generation and AI features tests

# Setup - ensure clean state with mock credentials
> env HOME=$WORK/test-home
> env NLM_AUTH_TOKEN=mock-token
> env NLM_COOKIES=mock-cookies
> mkdir -p $WORK/test-home/.nlm
> echo 'NLM_AUTH_TOKEN="mock-token"' > $WORK/test-home/.nlm/env
> echo 'NLM_COOKIES="mock-cookies"' >> $WORK/test-home/.nlm/env

# Test 1: Generate notebook guide
> exec ./nlm_test generate-guide mock-project-001
> stdout 'Notebook Guide'
> stdout 'Summary'
> stdout 'Key Topics'

# Test 2: Generate outline
> exec ./nlm_test generate-outline mock-project-001
> stdout 'Outline'
> stdout 'Section'
> stdout 'Subsection'

# Test 3: Generate FAQ
> exec ./nlm_test generate-faq mock-project-001
> stdout 'Frequently Asked Questions'
> stdout 'Q:'
> stdout 'A:'

# Test 4: Generate study guide
> exec ./nlm_test generate-study-guide mock-project-001
> stdout 'Study Guide'
> stdout 'Learning Objectives'
> stdout 'Key Concepts'

# Test 5: Generate timeline
> exec ./nlm_test generate-timeline mock-project-001
> stdout 'Timeline'
> stdout 'Date:'
> stdout 'Event:'

# Test 6: Generate briefing doc
> exec ./nlm_test generate-briefing mock-project-001
> stdout 'Briefing Document'
> stdout 'Executive Summary'
> stdout 'Background'

# Test 7: Audio overview creation
> exec ./nlm_test audio-create mock-project-001
> stdout 'Creating audio overview'
> stdout 'Audio overview created'

# Test 8: Get audio overview status
> exec ./nlm_test audio-status mock-project-001
> stdout 'Audio Overview Status'
> stdout 'State:'

# Test 9: Download audio overview
> exec ./nlm_test audio-download mock-project-001 $WORK/audio.mp3
> stdout 'Downloaded audio'
> stdout 'audio.mp3'

# Test 10: Video overview creation
> exec ./nlm_test video-create mock-project-001 https://youtube.com/watch?v=test
> stdout 'Creating video overview'
> stdout 'Video overview created'

# Test 11: Export all generated content
> exec ./nlm_test export mock-project-001 $WORK/export/
> stdout 'Exported to'
> stdout '$WORK/export/'
> stdout 'guide.md'
> stdout 'outline.md'

# Test 12: Interactive chat mode
> echo 'What is the main topic?' | exec ./nlm_test chat mock-project-001
> stdout 'Chat mode'
> stdout 'Response:'

# Test 13: Error handling - generation failure
> ! exec ./nlm_test generate-guide invalid-notebook-id
> stderr 'not found|failed to generate'

# Test 14: Streaming generation
> exec ./nlm_test generate-outline mock-project-001 --stream
> stdout 'Streaming'
> stdout 'Section'

# Test 15: Custom prompts for generation
> echo 'Custom prompt here' | exec ./nlm_test generate-custom mock-project-001 -
> stdout 'Generated content'