# Test security isolation for nlm CLI
# Ensures sensitive data (tokens, cookies, credentials) are properly isolated

# Test 1: Environment variable isolation - sensitive vars shouldn't leak to help output
env NLM_AUTH_TOKEN=super-secret-token-12345
env NLM_COOKIES=SID=secret123; HSID=hsidsecret456; SSID=ssidsecret789
env NLM_API_KEY=private-api-key-xyz
env GOOGLE_API_KEY=google-secret-key
exec ./nlm_test help
# Help output should NOT contain any sensitive data
! stdout 'super-secret-token'
! stdout 'secret123'
! stdout 'hsidsecret'
! stdout 'ssidsecret'
! stdout 'private-api-key'
! stdout 'google-secret-key'
! stderr 'super-secret-token'
! stderr 'secret123'
! stderr 'private-api-key'

# Test 2: Authentication required for commands without valid credentials
env NLM_AUTH_TOKEN=''
env NLM_COOKIES=''
! exec ./nlm_test ls
stderr 'Authentication required'
# Empty auth shouldn't try to show any values
! stderr 'NLM_AUTH_TOKEN'
! stderr 'NLM_COOKIES'

# Test 3: Debug mode security - ensure debug doesn't leak credentials in auth messages
env NLM_AUTH_TOKEN=''
env NLM_COOKIES=''
! exec ./nlm_test -debug ls
# Debug output should not show credential values (even if empty)
stderr 'debug mode enabled'
stderr 'Authentication required'
! stderr 'NLM_AUTH_TOKEN'
! stderr 'NLM_COOKIES'

# Test 4: Token handling security - real tokens not exposed when API fails
# Use a short/invalid token that passes auth check but fails API calls
env NLM_AUTH_TOKEN=shorttoken
env NLM_COOKIES=SID=shortcookie
! exec ./nlm_test ls
# Output should not contain the actual token values
! stderr 'shorttoken'
! stderr 'shortcookie'
! stdout 'shorttoken' 
! stdout 'shortcookie'

# Test 5: Debug mode doesn't expose token details in API errors
env NLM_AUTH_TOKEN=debugtoken123
env NLM_COOKIES=SID=debugcookie456
! exec ./nlm_test -debug ls
stderr 'debug mode enabled'
# Debug output should mask or omit sensitive values even during API errors
! stderr 'debugtoken123'
! stderr 'debugcookie456'
! stdout 'debugtoken123'
! stdout 'debugcookie456'
# But should show masked versions for debugging purposes  
stdout 'DEBUG: Token: de.*23'
stdout 'SID=de.*56'

# Test 6: Command-line flag security - auth passed via flags shouldn't leak
exec ./nlm_test -auth flag-secret-token -cookies 'flag-cookie-secret' help
# Help output shouldn't contain flag values
! stdout 'flag-secret-token'
! stdout 'flag-cookie-secret'
! stderr 'flag-secret-token'
! stderr 'flag-cookie-secret'

# Test 7: Profile flag with sensitive name should be masked in debug output
! exec ./nlm_test -debug -profile 'my-secret-profile-name' ls
stderr 'debug mode enabled'
# Profile name should be masked in debug output (testing masking functionality)
! stderr 'my-secret-profile-name'

# Test 8: Empty token scenarios still protect against variable name exposure
env NLM_AUTH_TOKEN=
env NLM_COOKIES=
! exec ./nlm_test feedback 'test message'
stderr 'Authentication required'
# Environment variable names shouldn't be exposed
! stdout 'NLM_AUTH_TOKEN'
! stdout 'NLM_COOKIES'
! stderr 'NLM_AUTH_TOKEN'
! stderr 'NLM_COOKIES'