# Comprehensive source management tests

# Setup - ensure clean state with mock credentials
> env HOME=$WORK/test-home
> env NLM_AUTH_TOKEN=mock-token
> env NLM_COOKIES=mock-cookies
> mkdir -p $WORK/test-home/.nlm
> echo 'NLM_AUTH_TOKEN="mock-token"' > $WORK/test-home/.nlm/env
> echo 'NLM_COOKIES="mock-cookies"' >> $WORK/test-home/.nlm/env

# Test 1: List sources in a notebook
> exec ./nlm_test sources mock-project-001
> stdout 'SOURCE ID\s+TITLE\s+TYPE'
> stdout 'mock-source-001\s+Test Document\s+text'

# Test 2: Add text source from string
> exec ./nlm_test add mock-project-001 "This is direct text content"
> stdout 'Added source'
> stdout 'to notebook'

# Test 3: Add text source from file
> echo 'File content for testing' > $WORK/test.txt
> exec ./nlm_test add mock-project-001 $WORK/test.txt
> stdout 'Added source'
> stdout 'test.txt'

# Test 4: Add URL source
> exec ./nlm_test add mock-project-001 https://example.com
> stdout 'Added source'
> stdout 'example.com'

# Test 5: Add YouTube source
> exec ./nlm_test add mock-project-001 https://youtube.com/watch?v=test123
> stdout 'Added source'
> stdout 'YouTube'

# Test 6: Add Google Drive source
> exec ./nlm_test add mock-project-001 https://drive.google.com/file/d/test/view
> stdout 'Added source'
> stdout 'Drive'

# Test 7: Delete source
> exec ./nlm_test rm-source mock-project-001 mock-source-001 -y
> stdout 'Deleted source'

# Test 8: Rename source
> exec ./nlm_test rename-source mock-project-001 mock-source-002 "New Title"
> stdout 'Renamed source'

# Test 9: Add multiple sources at once
> echo 'Content 1' > $WORK/file1.txt
> echo 'Content 2' > $WORK/file2.txt
> exec ./nlm_test add mock-project-001 $WORK/file1.txt $WORK/file2.txt
> stdout 'Added 2 sources'

# Test 10: Add source with title override
> exec ./nlm_test add mock-project-001 "Text content" --title "Custom Title"
> stdout 'Added source'
> stdout 'Custom Title'

# Test 11: Error handling - invalid notebook
> ! exec ./nlm_test sources invalid-notebook-id
> stderr 'not found|invalid'

# Test 12: Error handling - file not found
> ! exec ./nlm_test add mock-project-001 /nonexistent/file.txt
> stderr 'no such file'

# Test 13: Large file handling
> dd if=/dev/zero bs=1024 count=10000 > $WORK/large.bin 2>/dev/null
> exec ./nlm_test add mock-project-001 $WORK/large.bin
> stdout 'Added source|File too large|exceeded'

# Test 14: PDF file handling
> echo '%PDF-1.4 test content' > $WORK/test.pdf
> exec ./nlm_test add mock-project-001 $WORK/test.pdf
> stdout 'Added source'
> stdout 'test.pdf'